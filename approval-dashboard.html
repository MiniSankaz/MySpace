<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Orchestration - Approval Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s infinite; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .slide-in { animation: slideIn 0.3s ease-out; }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Header -->
    <div class="bg-gray-800 border-b border-gray-700">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <h1 class="text-2xl font-bold">ðŸ¤– AI Orchestration Dashboard</h1>
                    <span id="connectionStatus" class="px-3 py-1 rounded-full text-xs font-semibold bg-red-600">
                        Disconnected
                    </span>
                </div>
                <div class="text-sm text-gray-400">
                    <span id="currentTime"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="bg-gray-800 border-b border-gray-700">
        <div class="container mx-auto px-4 py-3">
            <div class="grid grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-yellow-400" id="pendingCount">0</div>
                    <div class="text-xs text-gray-400">Pending</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-400" id="approvedCount">0</div>
                    <div class="text-xs text-gray-400">Approved</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-400" id="rejectedCount">0</div>
                    <div class="text-xs text-gray-400">Rejected</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-400" id="activeAgents">0</div>
                    <div class="text-xs text-gray-400">Active Agents</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container mx-auto px-4 py-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Approval Queue -->
            <div class="lg:col-span-2">
                <div class="bg-gray-800 rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="mr-2">ðŸ“‹</span> Approval Queue
                    </h2>
                    <div id="approvalQueue" class="space-y-3">
                        <!-- Approval items will be inserted here -->
                    </div>
                    <div id="emptyQueue" class="text-center py-8 text-gray-500">
                        No pending approvals
                    </div>
                </div>
            </div>

            <!-- Agent Activity -->
            <div>
                <div class="bg-gray-800 rounded-lg p-4">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="mr-2">âš¡</span> Agent Activity
                    </h2>
                    <div id="agentActivity" class="space-y-2">
                        <!-- Agent activity will be inserted here -->
                    </div>
                    <div id="noActivity" class="text-center py-8 text-gray-500">
                        No active agents
                    </div>
                </div>

                <!-- Recent Decisions -->
                <div class="bg-gray-800 rounded-lg p-4 mt-6">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <span class="mr-2">ðŸ“œ</span> Recent Decisions
                    </h2>
                    <div id="recentDecisions" class="space-y-2 text-sm">
                        <!-- Recent decisions will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="fixed top-4 right-4 max-w-sm hidden">
        <div class="bg-yellow-600 text-white px-4 py-3 rounded-lg shadow-lg slide-in">
            <div class="flex items-center">
                <span class="text-2xl mr-3">ðŸ””</span>
                <div>
                    <div class="font-semibold" id="notificationTitle">New Approval Request</div>
                    <div class="text-sm" id="notificationBody">Description</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Approval Modal -->
    <div id="approvalModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4">
            <h3 class="text-xl font-bold mb-4" id="modalTitle">Approval Details</h3>
            
            <div class="space-y-3 mb-6">
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                        <span class="text-gray-400">Type:</span>
                        <span id="modalType" class="ml-2"></span>
                    </div>
                    <div>
                        <span class="text-gray-400">Risk:</span>
                        <span id="modalRisk" class="ml-2"></span>
                    </div>
                    <div>
                        <span class="text-gray-400">Requested By:</span>
                        <span id="modalRequestedBy" class="ml-2"></span>
                    </div>
                    <div>
                        <span class="text-gray-400">Time Left:</span>
                        <span id="modalTimeLeft" class="ml-2"></span>
                    </div>
                </div>
                
                <div class="mt-4">
                    <div class="text-gray-400 mb-2">Description:</div>
                    <div id="modalDescription" class="text-sm bg-gray-900 p-3 rounded"></div>
                </div>

                <div class="mt-4">
                    <div class="text-gray-400 mb-2">Context:</div>
                    <pre id="modalContext" class="text-xs bg-gray-900 p-3 rounded overflow-auto max-h-40"></pre>
                </div>
            </div>

            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded">
                    Cancel
                </button>
                <button onclick="rejectApproval()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded">
                    Reject
                </button>
                <button onclick="approveApproval()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded">
                    Approve
                </button>
                <button onclick="bypassApproval()" class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 rounded">
                    Emergency Bypass
                </button>
            </div>
        </div>
    </div>

    <script>
        // Mock data for testing
        const mockApprovals = [
            {
                id: 'req-001',
                type: 'CODE_DEPLOYMENT',
                title: 'Deploy authentication fix to production',
                description: 'Critical security patch for authentication module',
                requestedBy: 'agent-001',
                requestedAt: new Date(),
                expiresAt: new Date(Date.now() + 10 * 60000),
                status: 'pending',
                context: {
                    service: 'user-management',
                    riskLevel: 'high',
                    agentId: 'agent-001',
                    changes: ['auth.controller.ts', 'jwt.service.ts']
                }
            },
            {
                id: 'req-002',
                type: 'DATABASE_CHANGE',
                title: 'Add index to users table',
                description: 'Performance optimization for user queries',
                requestedBy: 'agent-002',
                requestedAt: new Date(),
                expiresAt: new Date(Date.now() + 30 * 60000),
                status: 'pending',
                context: {
                    service: 'database',
                    riskLevel: 'medium',
                    agentId: 'agent-002',
                    table: 'users',
                    operation: 'CREATE INDEX'
                }
            },
            {
                id: 'req-003',
                type: 'COST_EXCEEDING',
                title: 'Spawn 5 additional Opus agents',
                description: 'Parallel processing for large refactoring task',
                requestedBy: 'orchestrator',
                requestedAt: new Date(),
                expiresAt: new Date(Date.now() + 5 * 60000),
                status: 'pending',
                context: {
                    riskLevel: 'low',
                    estimatedCost: 25.50,
                    agentCount: 5,
                    model: 'claude-3-opus'
                }
            }
        ];

        const mockAgents = [
            { id: 'agent-001', type: 'business-analyst', status: 'working', task: 'Analyzing requirements', progress: 45 },
            { id: 'agent-002', type: 'code-reviewer', status: 'working', task: 'Reviewing code', progress: 78 },
            { id: 'agent-003', type: 'test-runner', status: 'initializing', task: 'Setting up tests', progress: 10 }
        ];

        let currentApproval = null;
        let socket = null;
        let isConnected = false;

        // Initialize
        function init() {
            updateTime();
            setInterval(updateTime, 1000);
            
            // Try to connect to server
            connectToServer();
            
            // Load mock data for demo
            loadMockData();
            
            // Update stats
            updateStats();
        }

        function connectToServer() {
            try {
                socket = io('http://localhost:4190', {
                    reconnection: true,
                    reconnectionDelay: 5000
                });

                socket.on('connect', () => {
                    isConnected = true;
                    updateConnectionStatus(true);
                    console.log('Connected to orchestration server');
                });

                socket.on('disconnect', () => {
                    isConnected = false;
                    updateConnectionStatus(false);
                });

                socket.on('approval:required', (approval) => {
                    addApprovalToQueue(approval);
                    showNotification(approval);
                });

                socket.on('agent:update', (agent) => {
                    updateAgentActivity(agent);
                });
            } catch (err) {
                console.log('Server not available, using mock data');
                updateConnectionStatus(false);
            }
        }

        function updateConnectionStatus(connected) {
            const status = document.getElementById('connectionStatus');
            if (connected) {
                status.textContent = 'Connected';
                status.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-green-600';
            } else {
                status.textContent = 'Mock Mode';
                status.className = 'px-3 py-1 rounded-full text-xs font-semibold bg-yellow-600';
            }
        }

        function updateTime() {
            document.getElementById('currentTime').textContent = 
                new Date().toLocaleString('en-US', { 
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
        }

        function loadMockData() {
            // Load approvals
            mockApprovals.forEach(approval => {
                addApprovalToQueue(approval);
            });

            // Load agents
            mockAgents.forEach(agent => {
                updateAgentActivity(agent);
            });
        }

        function addApprovalToQueue(approval) {
            const queue = document.getElementById('approvalQueue');
            const emptyMsg = document.getElementById('emptyQueue');
            
            emptyMsg.style.display = 'none';
            
            const riskColors = {
                low: 'bg-green-600',
                medium: 'bg-yellow-600',
                high: 'bg-orange-600',
                critical: 'bg-red-600'
            };

            const timeLeft = Math.floor((new Date(approval.expiresAt) - new Date()) / 60000);
            const urgencyClass = timeLeft < 5 ? 'text-red-400' : timeLeft < 15 ? 'text-yellow-400' : 'text-green-400';

            const item = document.createElement('div');
            item.className = 'bg-gray-900 rounded p-4 hover:bg-gray-700 cursor-pointer transition slide-in';
            item.id = `approval-${approval.id}`;
            item.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="font-semibold">${approval.title}</div>
                        <div class="text-sm text-gray-400 mt-1">${approval.description}</div>
                        <div class="flex items-center mt-2 space-x-4 text-xs">
                            <span class="px-2 py-1 rounded ${riskColors[approval.context.riskLevel]}">
                                ${approval.context.riskLevel.toUpperCase()}
                            </span>
                            <span>${approval.type.replace(/_/g, ' ')}</span>
                            <span>by ${approval.requestedBy}</span>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="${urgencyClass} font-semibold">${timeLeft}m</div>
                        <div class="text-xs text-gray-400">remaining</div>
                    </div>
                </div>
            `;
            
            item.onclick = () => showApprovalDetails(approval);
            queue.appendChild(item);
        }

        function updateAgentActivity(agent) {
            const activity = document.getElementById('agentActivity');
            const emptyMsg = document.getElementById('noActivity');
            
            emptyMsg.style.display = 'none';
            
            let item = document.getElementById(`agent-${agent.id}`);
            if (!item) {
                item = document.createElement('div');
                item.id = `agent-${agent.id}`;
                item.className = 'bg-gray-900 rounded p-3';
                activity.appendChild(item);
            }

            const statusColors = {
                initializing: 'text-yellow-400',
                working: 'text-green-400',
                completed: 'text-blue-400',
                failed: 'text-red-400'
            };

            item.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <div class="text-sm font-semibold">${agent.id}</div>
                    <div class="${statusColors[agent.status]} text-xs">${agent.status}</div>
                </div>
                <div class="text-xs text-gray-400 mb-2">${agent.task}</div>
                <div class="w-full bg-gray-700 rounded-full h-2">
                    <div class="bg-blue-500 h-2 rounded-full transition-all" style="width: ${agent.progress}%"></div>
                </div>
            `;
        }

        function showApprovalDetails(approval) {
            currentApproval = approval;
            
            document.getElementById('modalTitle').textContent = approval.title;
            document.getElementById('modalType').textContent = approval.type.replace(/_/g, ' ');
            document.getElementById('modalRisk').textContent = approval.context.riskLevel.toUpperCase();
            document.getElementById('modalRisk').className = `ml-2 font-semibold ${getRiskColor(approval.context.riskLevel)}`;
            document.getElementById('modalRequestedBy').textContent = approval.requestedBy;
            
            const timeLeft = Math.floor((new Date(approval.expiresAt) - new Date()) / 60000);
            document.getElementById('modalTimeLeft').textContent = `${timeLeft} minutes`;
            
            document.getElementById('modalDescription').textContent = approval.description;
            document.getElementById('modalContext').textContent = JSON.stringify(approval.context, null, 2);
            
            document.getElementById('approvalModal').classList.remove('hidden');
        }

        function getRiskColor(risk) {
            const colors = {
                low: 'text-green-400',
                medium: 'text-yellow-400',
                high: 'text-orange-400',
                critical: 'text-red-400'
            };
            return colors[risk] || 'text-gray-400';
        }

        function closeModal() {
            document.getElementById('approvalModal').classList.add('hidden');
            currentApproval = null;
        }

        function approveApproval() {
            if (!currentApproval) return;
            
            handleDecision('approved');
            showDecisionToast('Approved', 'green');
        }

        function rejectApproval() {
            if (!currentApproval) return;
            
            handleDecision('rejected');
            showDecisionToast('Rejected', 'red');
        }

        function bypassApproval() {
            if (!currentApproval) return;
            
            if (confirm('Emergency bypass will be logged and audited. Continue?')) {
                handleDecision('bypassed');
                showDecisionToast('Bypassed', 'yellow');
            }
        }

        function handleDecision(decision) {
            if (isConnected && socket) {
                socket.emit('approval:decision', {
                    requestId: currentApproval.id,
                    decision: decision,
                    decidedBy: 'user',
                    timestamp: new Date()
                });
            }
            
            // Remove from UI
            const item = document.getElementById(`approval-${currentApproval.id}`);
            if (item) {
                item.remove();
            }
            
            // Add to recent decisions
            addRecentDecision(currentApproval, decision);
            
            closeModal();
            updateStats();
        }

        function addRecentDecision(approval, decision) {
            const container = document.getElementById('recentDecisions');
            
            const decisionColors = {
                approved: 'text-green-400',
                rejected: 'text-red-400',
                bypassed: 'text-yellow-400'
            };
            
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center py-2 border-b border-gray-700';
            item.innerHTML = `
                <div class="flex-1 truncate">${approval.title}</div>
                <div class="${decisionColors[decision]}">${decision.toUpperCase()}</div>
            `;
            
            container.insertBefore(item, container.firstChild);
            
            // Keep only last 5 decisions
            while (container.children.length > 5) {
                container.removeChild(container.lastChild);
            }
        }

        function showNotification(approval) {
            const toast = document.getElementById('notificationToast');
            document.getElementById('notificationTitle').textContent = 'New Approval Request';
            document.getElementById('notificationBody').textContent = approval.title;
            
            toast.classList.remove('hidden');
            
            // Play sound if available
            const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE');
            audio.play().catch(() => {}); // Ignore if audio fails
            
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 5000);
        }

        function showDecisionToast(decision, color) {
            const toast = document.getElementById('notificationToast');
            const wrapper = toast.querySelector('div');
            
            wrapper.className = `bg-${color}-600 text-white px-4 py-3 rounded-lg shadow-lg slide-in`;
            document.getElementById('notificationTitle').textContent = `Request ${decision}`;
            document.getElementById('notificationBody').textContent = currentApproval.title;
            
            toast.classList.remove('hidden');
            setTimeout(() => {
                toast.classList.add('hidden');
            }, 3000);
        }

        function updateStats() {
            const pending = document.querySelectorAll('#approvalQueue > div').length;
            document.getElementById('pendingCount').textContent = pending;
            
            // Update other stats (mock for now)
            document.getElementById('approvedCount').textContent = 
                document.querySelectorAll('#recentDecisions .text-green-400').length;
            document.getElementById('rejectedCount').textContent = 
                document.querySelectorAll('#recentDecisions .text-red-400').length;
            document.getElementById('activeAgents').textContent = 
                document.querySelectorAll('#agentActivity > div').length;
        }

        // Initialize on load
        window.onload = init;
    </script>
</body>
</html>